# app.py
import time
import random
import math
from collections import defaultdict
import streamlit as st
import pandas as pd

st.set_page_config(page_title="ğŸ ë¯¸ë‹ˆ ê²½ë§ˆ í† í† ", page_icon="ğŸ", layout="centered")

# -----------------------------
# ì´ˆê¸° ìƒíƒœ
# -----------------------------
def init_state():
    if "balance" not in st.session_state:
        st.session_state.balance = 1000  # ì‹œì‘ ì½”ì¸
    if "horses" not in st.session_state:
        st.session_state.horses = [
            {"name": "ë²ˆê°œ", "rating": 1.00},
            {"name": "íƒœí’", "rating": 1.03},
            {"name": "ì§ˆì£¼", "rating": 0.98},
            {"name": "ì²œë‘¥", "rating": 1.01},
            {"name": "ë‚œì¶”", "rating": 0.96},
            {"name": "ì•¼ì„±", "rating": 1.05},
        ]
    if "user_bets" not in st.session_state:
        st.session_state.user_bets = defaultdict(int)
    if "bot_pool" not in st.session_state:
        st.session_state.bot_pool = defaultdict(int)
    if "race_in_progress" not in st.session_state:
        st.session_state.race_in_progress = False
    if "history" not in st.session_state:
        st.session_state.history = []  # [(winner, payout, net)]
    if "last_odds" not in st.session_state:
        st.session_state.last_odds = {}

init_state()

# -----------------------------
# ìœ í‹¸
# -----------------------------
def total_pool(user_bets, bot_pool):
    return sum(user_bets.values()) + sum(bot_pool.values())

def compute_odds(user_bets, bot_pool):
    pool = total_pool(user_bets, bot_pool)
    odds = {}
    for h in [x["name"] for x in st.session_state.horses]:
        bet_on_h = user_bets[h] + bot_pool[h]
        if bet_on_h > 0:
            odds[h] = pool / bet_on_h  # 1ì½”ì¸ ë°°íŒ… ì‹œ ì˜ˆìƒ ë°°ë‹¹(ì†Œìˆ˜ë°°ë‹¹)
        else:
            odds[h] = None
    return odds

def simulate_bots(user_bets):
    """ì‚¬ìš©ì ë² íŒ…ì´ ëë‚œ ë’¤, ë´‡ë“¤ì´ ë² íŒ…ì„ ì±„ì›Œ ë„£ì–´ ë°°ë‹¹ì´ ìì—°ìŠ¤ëŸ¬ì›Œì§€ê²Œ í•©ë‹ˆë‹¤."""
    bot_pool = defaultdict(int)
    base_total = random.randint(600, 2000)  # ë´‡ ì „ì²´ ë² íŒ… ì½”ì¸
    # ratingì´ ë†’ì„ìˆ˜ë¡ ì„ í˜¸ ê°€ì¤‘ì¹˜ â†‘
    weights = []
    for h in st.session_state.horses:
        # ì•½ê°„ì˜ ë…¸ì´ì¦ˆë¡œ í•œ íŒë§ˆë‹¤ ì„ í˜¸ ë³€ë™
        w = max(0.1, h["rating"] + random.uniform(-0.03, 0.05))
        weights.append(w)
    s = sum(weights)
    probs = [w / s for w in weights]
    amounts = [int(max(0, round(base_total * p + random.uniform(-10, 10)))) for p in probs]
    # ë¼ìš´ë”© ë³´ì •
    diff = base_total - sum(amounts)
    if amounts:
        amounts[0] += diff
    for (h, amt) in zip([x["name"] for x in st.session_state.horses], amounts):
        bot_pool[h] += max(0, amt)
    return bot_pool

def reset_bets(keep_balance=True):
    if keep_balance:
        bal = st.session_state.balance
    st.session_state.user_bets = defaultdict(int)
    st.session_state.bot_pool = defaultdict(int)
    st.session_state.last_odds = {}
    st.session_state.race_in_progress = False
    if keep_balance:
        st.session_state.balance = bal

# -----------------------------
# í—¤ë”
# -----------------------------
st.title("ğŸ ë¯¸ë‹ˆ ê²½ë§ˆ í† í†  (ê°€ìƒ ì½”ì¸)")
st.caption("ì‹¤ì œ ëˆì€ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê²½ë§ˆ ì‹œë®¬ë ˆì´ì…˜ ê²Œì„ì…ë‹ˆë‹¤. ì¦ê²ê³  ì±…ì„ê° ìˆê²Œ í”Œë ˆì´í•˜ì„¸ìš”!")

# -----------------------------
# ë² íŒ… ì„¹ì…˜
# -----------------------------
col_a, col_b = st.columns([1, 1])
with col_a:
    st.subheader("ë³´ìœ  ì½”ì¸")
    st.metric("ì”ì•¡", f"{st.session_state.balance:,} ğŸª™")

with col_b:
    st.subheader("íŠ¸ë™/ë§ˆí•„ ì •ë³´")
    df_h = pd.DataFrame(
        [{"ë§": h["name"], "ë ˆì´íŒ…": h["rating"]} for h in st.session_state.horses]
    )
    st.dataframe(df_h, use_container_width=True, hide_index=True)

st.divider()
st.subheader("ë² íŒ…")

horse_names = [h["name"] for h in st.session_state.horses]
sel = st.selectbox("ë§ì„ ê³ ë¥´ì„¸ìš”", options=horse_names, index=0)
amt = st.number_input("ë² íŒ… ì½”ì¸", 1, 10_000, 50, step=10)

bet_cols = st.columns([1, 1, 1])
with bet_cols[0]:
    if st.button("ë² íŒ… ì¶”ê°€"):
        if st.session_state.balance >= amt:
            st.session_state.user_bets[sel] += int(amt)
            st.session_state.balance -= int(amt)
            st.success(f"âœ… {sel} ì— {int(amt)} ì½”ì¸ ë² íŒ… ì™„ë£Œ!")
        else:
            st.error("ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.")

with bet_cols[1]:
    if st.button("í•´ë‹¹ ë§ ë² íŒ… ì·¨ì†Œ"):
        bet_back = st.session_state.user_bets[sel]
        if bet_back > 0:
            st.session_state.balance += bet_back
            st.session_state.user_bets[sel] = 0
            st.info(f"â†©ï¸ {sel}ì— ë² íŒ…í•œ {bet_back} ì½”ì¸ì„ ëŒë ¤ë°›ì•˜ìŠµë‹ˆë‹¤.")
        else:
            st.warning("í•´ë‹¹ ë§ì— ë² íŒ…ì´ ì—†ìŠµë‹ˆë‹¤.")

with bet_cols[2]:
    if st.button("ì „ì²´ ë² íŒ… ì´ˆê¸°í™”"):
        refunded = sum(st.session_state.user_bets.values())
        st.session_state.balance += refunded
        reset_bets(keep_balance=True)
        st.info(f"ëª¨ë“  ë² íŒ…ì„ ì·¨ì†Œí•˜ê³  {refunded} ì½”ì¸ì„ í™˜ë¶ˆí–ˆìŠµë‹ˆë‹¤.")

# í˜„ì¬ ë² íŒ… í˜„í™©
st.markdown("#### í˜„ì¬ ë² íŒ… (ì‚¬ìš©ì)")
df_bets = pd.DataFrame(
    [{"ë§": h, "ë² íŒ…": st.session_state.user_bets[h]} for h in horse_names]
)
df_bets.loc["í•©ê³„"] = ["í•©ê³„", df_bets["ë² íŒ…"].sum()]
st.dataframe(df_bets, use_container_width=True)

# -----------------------------
# ë ˆì´ìŠ¤ & ë°°ë‹¹ ê³„ì‚°
# -----------------------------
st.divider()
st.subheader("ë ˆì´ìŠ¤ & ë°°ë‹¹")

track_len = st.slider("íŠ¸ë™ ê¸¸ì´ (ë‹¨ìœ„: ì§„í–‰ë¥ )", min_value=50, max_value=150, value=100, step=10)
tick_delay = st.slider("í‹± ì§€ì—°(ì• ë‹ˆë©”ì´ì…˜ ì†ë„, ì´ˆ)", 0.01, 0.2, 0.05, step=0.01)

col_run = st.columns([1, 1, 1])
with col_run[0]:
    gen_bots = st.button("ì»´í“¨í„° ë² íŒ… ìƒì„±")
with col_run[1]:
    start_race = st.button("ğŸ ë ˆì´ìŠ¤ ì‹œì‘")
with col_run[2]:
    new_round = st.button("ë‹¤ìŒ ë¼ìš´ë“œ ì¤€ë¹„")

# ë´‡ ë² íŒ… ìƒì„±
if gen_bots and not st.session_state.race_in_progress:
    st.session_state.bot_pool = simulate_bots(st.session_state.user_bets)
    st.success("ğŸ¤– ì»´í“¨í„° ë² íŒ…ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.")

# ë°°ë‹¹(ì˜ˆìƒ) í‘œì‹œ
odds = compute_odds(st.session_state.user_bets, st.session_state.bot_pool)
st.session_state.last_odds = odds

df_odds = pd.DataFrame(
    [{
        "ë§": h,
        "ì‚¬ìš©ì ë² íŒ…": st.session_state.user_bets[h],
        "ì»´í“¨í„° ë² íŒ…": st.session_state.bot_pool[h],
        "í•©ê³„": st.session_state.user_bets[h] + st.session_state.bot_pool[h],
        "ì˜ˆìƒ ë°°ë‹¹(1ì½”ì¸ë‹¹)": (f"{odds[h]:.2f}" if odds[h] else "-"),
    } for h in horse_names]
)
df_odds.loc["í•©ê³„"] = [
    "í•©ê³„",
    df_odds["ì‚¬ìš©ì ë² íŒ…"].replace("-", 0).sum(),
    df_odds["ì»´í“¨í„° ë² íŒ…"].replace("-", 0).sum(),
    df_odds["í•©ê³„"].replace("-", 0).sum(),
    "",
]
st.dataframe(df_odds, use_container_width=True, hide_index=True)

# -----------------------------
# ë ˆì´ìŠ¤ ì‹œë®¬ë ˆì´ì…˜
# -----------------------------
def run_race():
    st.session_state.race_in_progress = True
    # í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì¤€ë¹„
    bars = {}
    labels = {}
    ph = st.empty()
    with ph.container():
        for h in horse_names:
            c1, c2 = st.columns([6, 1])
            with c1:
                bars[h] = st.progress(0, text=f"ğŸ {h}")
            with c2:
                labels[h] = st.empty()

    # ë§ ìƒíƒœ
    pos = {h["name"]: 0.0 for h in st.session_state.horses}
    # ë ˆì´íŒ…ì„ ì†ë„ ê°€ì¤‘ì¹˜ë¡œ ë°˜ì˜
    base_speed = {h["name"]: h["rating"] for h in st.session_state.horses}
    winner = None
    finish_order = []

    while True:
        for h in horse_names:
            # ê°€ì†/ê°ì† ë³€ë™ í¬í•¨
            step = random.uniform(0.8, 1.3) * base_speed[h]
            # ì•½ê°„ì˜ ìŠ¤í¼íŠ¸ ì´ë²¤íŠ¸
            if random.random() < 0.05:
                step *= random.uniform(1.3, 1.6)
            pos[h] = min(track_len, pos[h] + step)
            pct = int(pos[h] / track_len * 100)
            bars[h].progress(pct, text=f"ğŸ {h}  |  {pct}%")
            labels[h].markdown(f"**{pct}%**")

            if pct >= 100 and h not in finish_order:
                finish_order.append(h)

        if finish_order:
            winner = finish_order[0]
        if all(p >= track_len for p in pos.values()):
            break
        time.sleep(tick_delay)

    # ê²°ê³¼ & ë°°ë‹¹ ì •ì‚° (íŒ¨ë¦¬ë®¤ì¶”ì–¼)
    pool = total_pool(st.session_state.user_bets, st.session_state.bot_pool)
    bet_on_winner = st.session_state.user_bets[winner] + st.session_state.bot_pool[winner]
    payout_per_coin = pool / bet_on_winner if bet_on_winner > 0 else 0.0
    user_win = st.session_state.user_bets[winner] * payout_per_coin
    net = int(round(user_win))  # ì†Œìˆ˜ì  ì ˆì‚¬

    st.success(f"ğŸ† ìš°ìŠ¹: **{winner}**  |  ë°°ë‹¹(1ì½”ì¸ë‹¹): **{payout_per_coin:.2f}**")
    if st.session_state.user_bets[winner] > 0:
        st.balloons()
        st.write(f"ë‹¹ì‹ ì€ {winner}ì— {st.session_state.user_bets[winner]} ì½”ì¸ì„ ê±¸ì—ˆê³  **{net} ì½”ì¸**ì„ íšë“í–ˆìŠµë‹ˆë‹¤!")
        st.session_state.balance += net
    else:
        st.write("ì•„ì‰½ì§€ë§Œ ìš°ìŠ¹ ë§ì— ë² íŒ…í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ìŒì„ ë…¸ë ¤ë´ìš”!")

    # íˆìŠ¤í† ë¦¬ ì €ì¥
    st.session_state.history.append((winner, round(payout_per_coin, 2), net))
    st.session_state.race_in_progress = False

if start_race and not st.session_state.race_in_progress:
    # ë² íŒ… ê²€ì¦
    if sum(st.session_state.user_bets.values()) == 0:
        st.warning("ìµœì†Œ 1ì½”ì¸ ì´ìƒ ë² íŒ… í›„ ì‹œì‘í•˜ì„¸ìš”.")
    else:
        if sum(st.session_state.bot_pool.values()) == 0:
            # ë´‡ ë² íŒ…ì´ ì—†ë‹¤ë©´ ìë™ ìƒì„±
            st.session_state.bot_pool = simulate_bots(st.session_state.user_bets)
        run_race()

if new_round and not st.session_state.race_in_progress:
    reset_bets(keep_balance=True)
    st.info("ìƒˆ ë¼ìš´ë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ë² íŒ…ì„ ë‹¤ì‹œ í•´ì£¼ì„¸ìš”!")

# -----------------------------
# ê¸°ë¡
# -----------------------------
st.divider()
st.subheader("ğŸ“œ ìµœê·¼ ë¼ìš´ë“œ ê¸°ë¡")
if st.session_state.history:
    df_hist = pd.DataFrame(
        [{"ë¼ìš´ë“œ": i+1, "ìš°ìŠ¹": w, "ë°°ë‹¹(1ì½”ì¸)": p, "ë‚´ ìˆ˜ìµ(+ì½”ì¸)": n}
         for i, (w, p, n) in enumerate(st.session_state.history[::-1])]
    )
    st.dataframe(df_hist, use_container_width=True, hide_index=True)
else:
    st.write("ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë² íŒ…ì„ ì‹œì‘í•´ë³´ì„¸ìš”!")

st.caption("â€» ì´ ì•±ì€ ì˜¤ë½ìš© ì‹œë®¬ë ˆì´ì…˜ì…ë‹ˆë‹¤. ì‹¤ì œ ë„ë°•ì„ ì¡°ì¥í•˜ì§€ ì•Šìœ¼ë©°, ê¸ˆì „ì  ì†ì‹¤/ì´ìµì´ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
